# XL-MSDigger
Here, we constructed Deep4D-XL, a deep learning tool capable of accurately predicting cross-linked peptide’s multi-dimensional information, including retention time, collisional cross-section, fragment ion intensity. Using Deep4D-XL as the core, we developed XL-MSDigger, a pipeline for comprehensive analysis of cross-linking mass spectrometry data acquired through both DDA and DIA approaches.
## Environment Setup
Create a new conda environment first:
```
conda create --name XLMSDigger python=3.9
```
Activate this environment by running:
```
conda activate XLMSDigger
```
then install dependencies:
```
pip install -r ./requirements.txt
```
Please download the checkpoint folder from [checkpoint.zip](https://drive.google.com/file/d/1tXZIgpxKFgSOx_0K42nrSTh9U11vFkc7/view?usp=sharing) and extract it to the 'XL-MSDigger-main/Deep4D_XL/checkpoint' path.
## Run Instructions of XL-MSDigger
### DDA XL-MS analysis 
#### Rescoring of DDA XL-MS results
This step performs rescoring on the results generated by the DDA software. Now XL-MSDigger support plink2, pLink3 and Scout.
```
python XL-MSDigger_DDA_plink.py --plinkfile './test_data/plink_test' --mgf_dir './test_data/test.mgf' --rescore_model 'dnn'
```
Description of argparse:  
--plinkfile: The file directory of pLink output.  
--mgf_dir: The file directory of mgf file.  
--rescore_model: You can select 'dnn' and 'svm'.  
It can also export mzIdentML (v1.2) after rescoring. Provide `--fasta` and the script will write a `.mzid` next to the rescored CSV.
Test MGF data: [test.mgf](https://drive.google.com/file/d/1NkTArho0gmGIBLsbBz7VM5W4V1sap5WW/view?usp=sharing),
Test pLink2 results folder: [plink_test.zip](https://drive.google.com/file/d/1RhtQTLLn5a7OrKfJTYmioHocx_fxtLlq/view?usp=sharing).
### DIA XL-MS analysis 
#### Building spectral library  
This step is used to build a predicted spectral library for proteins (intra-protein crosslinks) or PPIs (inter-protein crosslinks of interest.
```
python Build_library.py --experiment_library './test_data/experimental_library.csv' --aim_protein './test_data/test_PPI.csv' --aim_type 1 --fasta_dir './test_data/human_reviewed.fasta'
```
Description of argparse:  
--experiment_library: The file directory of experimental library.  
--aim_protein: The file directory of aim protein or PPI.  
--aim_type: Type of target (protein or PPI). Use 0 for proteins or 1 for PPIs.  
--fasta_dir: The file directory of fasta file.   
Experimental_library data: [experimental_library](https://drive.google.com/file/d/1DmDQv-QUX7tvyAgu30jqn3srfQMghET_/view?usp=sharing),
test_PPI data: [test_PPI](https://drive.google.com/file/d/1pHGtpFXhumuXi_tg1BFoqvKly040mii6/view?usp=sharing),
fasta data: [fasta file](https://drive.google.com/file/d/1QC0zpgYdvGW22NvOXUvu5mulwFHyl_Tw/view?usp=sharing).
#### Rescoring of DIA XL-MS results
This step is used to rescore the output results from DIA-NN and output the identified cross-linked peptides belonging to proteins or protein-protein interactions of interest.
```
python XL-MSDigger_DIA.py --diann_report './test_data/report.tsv' --DIA_library './test_data/experimental_library_with_aim_normal_lib.csv' --fasta_dir './test_data/human_reviewed.fasta'  --peptide_protein_list './test_data/test_peptide&protein.csv'
```
Description of argparse:  
--diann_report: The file directory of DIA-NN report.  
--DIA_library: The spectral library file containing "with_aim_normal_lib.csv" in its name, generated by the "Building spectral library" step.  
--fasta_dir: The file directory of fasta file.  
--peptide_protein_list: The file containing "peptide&protein.csv" in its name, generated by the "Building spectral library" step.  
test diann_report: [report.tsv](https://drive.google.com/file/d/1vLsqdUGnaqKnAyt7aRDxJ0I2FBIj4GQu/view?usp=sharing),
DIA_library data: [DIA_library](https://drive.google.com/file/d/15IOg0bPPW7zpau6-PUt5N_wXoITI3tK8/view?usp=sharing),
fasta data: [fasta file](https://drive.google.com/file/d/1QC0zpgYdvGW22NvOXUvu5mulwFHyl_Tw/view?usp=sharing),
peptide_protein_list: [peptide&protein_list](https://drive.google.com/file/d/1Bkw8mOUupGk5F3ANTLWPIs2NZkjgA1e3/view?usp=sharing).

## Run Instructions of Deep4D-XL
This step is intended for users who want to independently train the MS/MS, RT, or CCS prediction models. Although XL-MSDigger already includes the ability to fine-tune models based on each file’s results, you can independently train these modules if you are working with a new cross-linker or have a large amount of batch-specific data.
### a. Train ccs model  
#### 1. Encoding 
Run `'Deep4D_XL/CCS/dataset/Crosslink_Encoding.py'`. 
```
python Crosslink_Encoding.py --filename 'CCS_train'
```
Note: CCS_train.csv must be placed under Deep4D_XL/CCS/dataset/data/
#### 2. Train ccs model
Run `'Deep4D_XL/CCS/train_ccs.py'` 
```
python train_ccs.py --filename 'CCS_train' --load_ccs_param_dir 'Deep4D_XL/CCS/checkpoint/ccs.pth' 
```
--filename: Training data name.  
--load_ccs_param_dir: The file directory of pre-trained ccs model.  
Finally, find the parameters file at 'Deep4D_XL/CCS/checkpoint/{filename}_ccs/', where you can select the model checkpoint with the lowest MedianRE.
### b. Train rt model  
#### 1. Encoding 
Run `'Deep4D_XL/RT/dataset/Crosslink_Encoding.py'`. 
```
python Crosslink_Encoding.py --filename 'RT_train'
```
Note: RT_train.csv must be placed under Deep4D_XL/RT/dataset/data/
#### 2. Train rt model
Run `'Deep4D_XL/RT/train_rt.py'` 
```
python train_rt.py --filename 'RT_train' --load_rt_param_dir 'Deep4D_XL/RT/checkpoint/rt.pth' 
```
--filename: Training data name.  
--load_rt_param_dir: The file directory of pre-trained rt model  
Finally, find the parameters file at 'Deep4D_XL/RT/checkpoint/{filename}_rt/', where you can select the model checkpoint with the lowest MAE.
### c. Train msms model  
#### 1. Encoding 
For the non-cleavable crosslinker, run `'RT/dataset/Crosslink_Encoding_NC.py'`. For the cleavable crosslinker, Run `'Deep4D_XL/MSMS/Crosslink_Encoding_C.py'`.
```
python Crosslink_Encoding_NC.py --filename 'MSMS_train'
```
Note: MSMS_train.csv must be placed under Deep4D_XL/MSMS/dataset/data
#### 2. Train msms model
For the non-cleavable crosslinker, run `'Deep4D_XL/MSMS/train_crosslink_msms_NC.py'`. For the cleavable crosslinker, Run `'Deep4D_XL/MSMS/train_crosslink_msms_C.py'`.
```
python train_crosslink_msms_NC.py --filename 'MSMS_train' --load_msms_param_dir 'Deep4D_XL/RT/checkpoint/msms_nc.pth' 
```
--filename: Training data name.  
--load_msms_param_dir: The file directory of pre-trained msms model  
Finally, find the parameters file at 'Deep4D_XL/MSMS/checkpoint/{filename}_msms/', where you can select the model checkpoint with the highest dot product.
## Contacts
Please report any problems directly to the github issue tracker. Also, you can send feedback to moran.chen@bcm.edu.
